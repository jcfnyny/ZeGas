# ü™ô **ZeGas Smart Transfer ‚Äî Product Requirements Document (PRD)**

## Executive Summary
**ZeGas** is a smart scheduling protocol that automates single-token transfers between blockchain accounts based on gas price conditions. It monitors real-time gas oracles (1inch, Chainlink) and executes transactions only when network fees meet user-defined thresholds ‚Äî optimizing cost, timing, and reliability.  

By combining **EIP-1559 awareness**, **time-based scheduling**, and **permit-based approvals**, ZeGas enables individuals and DeFi platforms to perform **low-cost, automated transfers** without constant manual monitoring. The MVP focuses on Ethereum and compatible L2s, with expansion to cross-chain execution in later phases.

---

## 1. Overview
**ZeGas** enables users to **schedule ERC-20 or native token transfers** between two accounts on the same network, executing only when **gas fees fall within defined thresholds**.  
The system automates delayed or cost-optimized transfers by monitoring live gas prices (via a 1inch or Chainlink oracle) and triggering the transaction once user-defined criteria are met.

### Core Concept
> *‚ÄúDon‚Äôt send until it‚Äôs cheap.‚Äù*  
A user defines transfer details (token, amount, destination) plus conditions (`max gas`, `time window`).  
A backend or relayer continuously monitors gas prices and executes the transaction only when the thresholds are met ‚Äî or cancels/defers if they expire.

---

## 2. Objectives

| Goal | Description |
|------|--------------|
| **Gas Efficiency** | Reduce average gas cost for scheduled transfers. |
| **Automation** | Enable non-interactive, rule-based transactions. |
| **Security** | Ensure execution only under valid conditions with replay protection. |
| **Transparency** | Provide auditable logs and on-chain proof of conditions. |
| **Extensibility** | Support additional scheduling criteria (e.g., block time, oracle feed, volatility). |

---

## 3. Functional Requirements

### 3.1 Core Transfer
| Parameter | Type | Description |
|------------|------|-------------|
| `network` | string | Blockchain name (e.g., `"ethereum"`, `"arbitrum"`) |
| `chainId` | number | Chain identifier |
| `token` | string | ERC-20 address or `"native"` |
| `from` | string | Sender wallet address |
| `to` | string | Recipient wallet address |
| `amount` | string | Token amount in smallest units |
| `decimals` | number | Token decimals for human conversion |
| `nonceStrategy` | enum | `"latest"` (auto) or `"manual"` (user-specified `nonce`) |

### 3.2 Scheduling / Timing
| Parameter | Type | Description |
|------------|------|-------------|
| `type` | enum | `"once"`, `"window"`, `"recurring"` |
| `startTime` | ISO datetime | Earliest execution time |
| `endTime` | ISO datetime | Expiration / latest execution time |
| `cron` | string | Optional cron rule (if recurring) |
| `retryPolicy` | object | `{ maxAttempts, backoffSeconds }` |
| `timeZone` | string | User time zone |

### 3.3 Gas Price Triggers
| Parameter | Type | Description |
|------------|------|-------------|
| `gasOracle` | string | `"1inch"`, `"chainlink"`, `"custom"` |
| `executeWhen` | object | Condition set:<br>‚Ä¢ `baseFeeGwei <= X`<br>‚Ä¢ `maxFeePerGasGwei <= X`<br>‚Ä¢ `maxPriorityFeePerGasGwei <= Y`<br>‚Ä¢ `estimatedTotalCostEth <= Z` |
| `maxFeePerGasGwei` | number | Hard transaction cap |
| `maxPriorityFeePerGasGwei` | number | Max tip |
| `gasLimitCap` | number | Maximum allowed gas limit |
| `allowOutOfOrder` | boolean | Execute if threshold slightly exceeded and window ending |

### 3.4 Funding & Fees
| Parameter | Type | Description |
|------------|------|-------------|
| `feePayer` | enum | `"sender"`, `"sponsor"`, `"paymaster4337"` |
| `executionFeeBps` | number | Optional platform fee (basis points) |
| `refundTo` | string | Return leftover gas funds |
| `allowanceSource` | enum | `"approve-now"`, `"permit"` |

### 3.5 Execution Behavior
| Parameter | Type | Description |
|------------|------|-------------|
| `executorType` | enum | `"EOA"`, `"relayer"`, `"erc4337"` |
| `simulateBeforeSend` | boolean | Dry-run execution simulation |
| `minConfirmations` | number | Required block confirmations |
| `reorgSafetyBlocks` | number | Delay before confirming finality |

### 3.6 Cancellation & Overrides
| Parameter | Type | Description |
|------------|------|-------------|
| `cancelable` | boolean | User can revoke before execution |
| `cancelBefore` | ISO datetime | Deadline to cancel |
| `onWindowExpiry` | enum | `"cancel"`, `"executeAtMarket"` |

### 3.7 Notifications
| Parameter | Type | Description |
|------------|------|-------------|
| `webhookUrl` | string | POST updates to user system |
| `notify` | object | `{ email?, sms?, webhook? }` |
| `correlationId` | string | External trace ID |

### 3.8 Security & Auth
| Parameter | Type | Description |
|------------|------|-------------|
| `auth` | object | `{ type, signature, sig }` |
| `replayProtection` | object | `{ chainId, salt, userNonce }` |
| `allowedRelayers` | array | Whitelisted executors |
| `whitelistReceivers` | array | Optional recipient list |
| `requireChainId` | number | EIP-155 replay safety |

### 3.9 Permit (EIP-2612)
| Parameter | Type | Description |
|------------|------|-------------|
| `usePermit` | boolean | Enable permit flow |
| `permit` | object | `{ owner, spender, value, deadline, nonce, sig }` |
| `fallbackToApprove` | boolean | On permit failure, revert to `approve` |

### 3.10 Metadata
| Parameter | Type | Description |
|------------|------|-------------|
| `purpose` | string | Transfer reason (e.g., `"treasury"`) |
| `memo` | string | User message |
| `tags` | array | Classification labels |

---

## 4. Example Use Cases

### 4.1 One-Time ERC-20 Transfer (Permit)
- **User** schedules transfer of 250 USDC  
- Executes when `baseFee ‚â§ 12 Gwei`  
- Valid between `2025-10-21T19:30Z` and `2025-10-22T19:30Z`  
- Cancels automatically if threshold unmet.

### 4.2 Native ETH Transfer
- Sends 0.01 ETH if total tx cost ‚â§ 0.0103 ETH  
- Executes in 2-hour window  
- Refunds leftover gas to sender.

---

## 5. Non-Functional Requirements

| Category | Requirement |
|-----------|-------------|
| **Security** | All messages EIP-191 signed; on-chain execution validated by nonce. |
| **Reliability** | 99.9% uptime for gas oracle and executor queue. |
| **Performance** | Latency < 2 s between trigger condition and broadcast. |
| **Scalability** | Must handle 10k+ active scheduled jobs per network. |
| **Auditability** | Each job logs gas oracle readings and trigger event hash. |
| **Compliance** | Compatible with U.S. & EU crypto payment licensing; does not custody assets. |

---

## 6. System Architecture (high-level)
```
[User Frontend / API]
        |
        v
[Scheduler Service] --- monitors ---> [Gas Oracle API (1inch/Chainlink)]
        |
        v
[Execution Engine / Relayer]
        |
        v
[Blockchain Network]
```
- **Scheduler** stores user jobs, polls gas feeds.  
- **Execution Engine** signs and submits transactions when criteria met.  
- **Relayer** can be self-hosted or delegated.  
- **Webhooks** deliver status callbacks.

---

## 7. Milestones

| Phase | Deliverable | Target |
|--------|--------------|--------|
| v0.1 | JSON schema validation + local simulation | Week 1 |
| v0.2 | 1inch oracle integration + manual trigger | Week 2 |
| v0.3 | Automated scheduling (time + gas threshold) | Week 3 |
| v0.4 | Permit support + cancel flow | Week 4 |
| v1.0 | Production dashboard + webhook notifications | Week 6 |

---

## 8. Open Questions
1. Which gas oracle is canonical (1inch vs Chainlink vs both)?  
2. Should thresholds use *median* of N samples or latest tick?  
3. Is ERC-4337 bundling required for sponsor gas?  
4. Should expired jobs auto-refund service fees?  
5. Integration with ZeVault treasury layer for recurring payouts?
